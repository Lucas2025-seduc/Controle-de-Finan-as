<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA Meta Tags -->
    <title>Nexus Finanças</title>
    <meta name="description" content="Controle financeiro inteligente, seguro e offline. Gerencie suas finanças pessoais com facilidade.">
    <meta name="theme-color" content="#0f172a">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <!-- Estilos -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React e Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Biblioteca para Gerar PDF Real -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <!-- Biblioteca para Gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* Animações */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse-soft { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes scaleIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .animate-fadeIn { animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1); }
        .animate-pulse-soft { animation: pulse-soft 3s infinite; }
        .animate-slideUp { animation: slideUp 0.4s ease-out; }
        .animate-scaleIn { animation: scaleIn 0.3s ease-out; }
        
        /* Vidro e Efeitos */
        .bg-glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); }
        
        /* Barra de Rolagem Personalizada */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        ::-webkit-scrollbar-thumb:hover { background-color: #94a3b8; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Ajustes para Impressão/PDF */
        @media print {
            body { background: white; }
            #root { display: none; }
            #report-content, #report-content * { visibility: visible; display: block; }
            #report-content { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; }
            .no-print { display: none !important; }
        }

        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: env(safe-area-inset-top); }
    </style>
</head>
<body class="bg-slate-900 text-slate-200 font-sans antialiased selection:bg-emerald-500 selection:text-white min-h-screen">
    
    <!-- Ajuste do container principal para ser responsivo -->
    <div id="root" class="w-full min-h-screen bg-slate-50 relative shadow-2xl mx-auto md:max-w-6xl md:my-8 md:rounded-3xl md:overflow-hidden md:min-h-[calc(100vh-4rem)]"></div>

    <script type="text/babel">
        // --- CÓDIGO REACT ---
        const { useState, useEffect, useMemo, useRef } = React;
        const SEU_WHATSAPP_VENDAS = "558899361992"; 
        const LICENSE_PRICE = "R$ 59,99";
        const SALT = "SILVACE-SECRET-2025"; 
        const FREE_LIMIT = 10; 

        // Lista de Categorias
        const CATEGORIES = [
            "Água", "Animal de estimação", "Beleza", "Colaborador", "Combustível", "Contador", "Educação", 
            "Eletrodomésticos", "Energia", "Fast food", "Feira", "Fornecedor", "Imposto", 
            "Internet", "Investimentos", "Jurídico", "Lazer", "Luz", "Manutenção de veículos", "Outras prestações", 
            "Prestação da casa", "Prestação do carro", "Reforma/manutenção/ornamentação", 
            "Salário", "Saúde", "Streaming", "Transporte", "Utensílios", 
            "Vendas", "Vestimenta"
        ].sort();

        const getDeviceId = () => {
            let id = localStorage.getItem('nexus_device_id');
            if (!id) {
                id = Math.random().toString(36).substring(2, 6).toUpperCase();
                localStorage.setItem('nexus_device_id', id);
            }
            return id;
        };

        const verifyUniqueKey = (key, deviceId) => {
            try {
                if (!key || !deviceId) return false;
                const parts = key.trim().toUpperCase().split('-');
                if (parts.length !== 4) return false;
                const signature = parts[3];
                let combined = parts[1] + parts[2] + deviceId + SALT;
                let hash = 0;
                for (let i = 0; i < combined.length; i++) { hash = ((hash << 5) - hash) + combined.charCodeAt(i); hash |= 0; }
                const expectedSignature = Math.abs(hash).toString(16).substring(0, 4).toUpperCase().padStart(4, '0');
                return signature === expectedSignature;
            } catch (e) { return false; }
        };

        // ... ÍCONES ...
        const Icon = ({ children, className, size = 24 }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>);
        const Icons = {
            Wallet: (p) => <Icon {...p}><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/></Icon>,
            TrendingUp: (p) => <Icon {...p}><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></Icon>,
            TrendingDown: (p) => <Icon {...p}><polyline points="22 17 13.5 8.5 8.5 13.5 2 7"/><polyline points="16 17 22 17 22 11"/></Icon>,
            Plus: (p) => <Icon {...p}><path d="M5 12h14"/><path d="M12 5v14"/></Icon>,
            Trash2: (p) => <Icon {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></Icon>,
            List: (p) => <Icon {...p}><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></Icon>,
            Home: (p) => <Icon {...p}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></Icon>,
            X: (p) => <Icon {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></Icon>,
            Pencil: (p) => <Icon {...p}><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></Icon>,
            FileText: (p) => <Icon {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></Icon>,
            Settings: (p) => <Icon {...p}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></Icon>,
            Download: (p) => <Icon {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></Icon>,
            Upload: (p) => <Icon {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></Icon>,
            CheckCircle2: (p) => <Icon {...p}><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="m9 12 2 2 4-4"/></Icon>,
            Lock: (p) => <Icon {...p}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></Icon>,
            Crown: (p) => <Icon {...p}><path d="m2 4 3 12h14l3-12-6 7-4-7-4 7-6-7zm3 16h14"/></Icon>,
            ShieldCheck: (p) => <Icon {...p}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="m9 12 2 2 4-4"/></Icon>,
            MessageCircle: (p) => <Icon {...p}><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></Icon>,
            LogOut: (p) => <Icon {...p}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></Icon>,
            Smartphone: (p) => <Icon {...p}><rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12.01" y2="18"/></Icon>,
            Copy: (p) => <Icon {...p}><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></Icon>,
            Database: (p) => <Icon {...p}><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></Icon>,
            Infinity: (p) => <Icon {...p}><path d="M12 12c-2-2.67-4-4-6-4a4 4 0 1 0 0 8c2 0 4-1.33 6-4Zm0 0c2 2.67 4 4 6 4a4 4 0 1 0 0-8c-2 0-4 1.33-6 4Z"/></Icon>,
            AlertOctagon: (p) => <Icon {...p}><polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></Icon>
        };

        const ReportModal = ({ transactions, month, onClose }) => {
            const [isGenerating, setIsGenerating] = useState(false);
            const incomeChartRef = useRef(null);
            const expenseChartRef = useRef(null);

            const reportData = useMemo(() => {
                const filtered = transactions.filter(t => t.date.startsWith(month));
                const stats = filtered.reduce((acc, curr) => {
                    curr.type === 'income' ? acc.income += curr.amount : acc.expense += curr.amount;
                    
                    // Stats by method
                    if(!acc.byMethod[curr.method]) acc.byMethod[curr.method] = 0;
                    acc.byMethod[curr.method] += curr.amount;
                    
                    // Stats by category
                    const cat = curr.category || 'Outros';
                    if (curr.type === 'income') {
                        if(!acc.byCatIncome[cat]) acc.byCatIncome[cat] = 0;
                        acc.byCatIncome[cat] += curr.amount;
                    } else {
                        if(!acc.byCatExpense[cat]) acc.byCatExpense[cat] = 0;
                        acc.byCatExpense[cat] += curr.amount;
                    }

                    return acc;
                }, { income: 0, expense: 0, byMethod: {}, byCatIncome: {}, byCatExpense: {} });
                return { filtered: filtered.sort((a,b) => new Date(a.date) - new Date(b.date)), stats };
            }, [transactions, month]);

            // Configurar Gráficos
            useEffect(() => {
                if (!incomeChartRef.current || !expenseChartRef.current) return;

                // Prepare Data for Charts (Sorted Descending)
                const incomeCats = Object.entries(reportData.stats.byCatIncome)
                    .sort(([,a], [,b]) => b - a);
                const expenseCats = Object.entries(reportData.stats.byCatExpense)
                    .sort(([,a], [,b]) => b - a);

                // Income Chart
                const incomeChart = new Chart(incomeChartRef.current, {
                    type: 'bar',
                    data: {
                        labels: incomeCats.map(([k]) => k),
                        datasets: [{
                            label: 'Entradas',
                            data: incomeCats.map(([,v]) => v),
                            backgroundColor: '#10b981', // emerald-500
                            borderRadius: 4
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: { x: { grid: { display: false } }, y: { grid: { display: false } } }
                    }
                });

                // Expense Chart
                const expenseChart = new Chart(expenseChartRef.current, {
                    type: 'bar',
                    data: {
                        labels: expenseCats.map(([k]) => k),
                        datasets: [{
                            label: 'Saídas',
                            data: expenseCats.map(([,v]) => v),
                            backgroundColor: '#f43f5e', // rose-500
                            borderRadius: 4
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: { x: { grid: { display: false } }, y: { grid: { display: false } } }
                    }
                });

                return () => {
                    incomeChart.destroy();
                    expenseChart.destroy();
                };
            }, [reportData]);

            const downloadPDF = () => {
                setIsGenerating(true);
                const element = document.getElementById('report-content');
                const opt = { margin: 5, filename: `relatorio-nexus-${month}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
                html2pdf().set(opt).from(element).save().then(() => setIsGenerating(false));
            };

            const methodMap = { 'pix': 'Pix', 'money': 'Dinheiro', 'card_credit': 'Crédito', 'card_debit': 'Débito', 'cheque': 'Cheque' };

            return (
                <div className="fixed inset-0 bg-slate-900/90 backdrop-blur-sm z-[100] flex items-center justify-center p-0 sm:p-4 overflow-y-auto">
                    <div className="bg-white w-full max-w-2xl min-h-screen sm:min-h-0 sm:rounded-2xl shadow-2xl animate-scaleIn text-slate-800 flex flex-col relative">
                        <div className="p-4 border-b border-gray-200 bg-slate-50 sm:rounded-t-2xl flex justify-between items-center no-print" data-html2canvas-ignore="true">
                            <h2 className="text-lg font-bold text-slate-800 flex items-center gap-2"><Icons.FileText className="text-emerald-600"/> Relatório Mensal</h2>
                            <div className="flex gap-2">
                                <button onClick={downloadPDF} disabled={isGenerating} className="px-3 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 flex items-center gap-2 text-sm font-bold shadow disabled:opacity-50">{isGenerating ? 'Gerando...' : <><Icons.Download size={18}/> Baixar PDF</>}</button>
                                <button onClick={onClose} className="p-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-600"><Icons.X size={20}/></button>
                            </div>
                        </div>
                        <div className="p-8 overflow-y-auto bg-white" id="report-content">
                            <div className="text-center mb-8 border-b-2 border-emerald-500 pb-4">
                                <h1 className="text-3xl font-black text-slate-900 mb-1">Nexus Finanças</h1>
                                <p className="text-slate-500 uppercase tracking-widest text-xs font-bold">Relatório Financeiro Detalhado</p>
                                <p className="text-lg font-medium text-slate-700 mt-2 capitalize bg-slate-100 inline-block px-4 py-1 rounded-full border border-slate-200">{new Date(month + '-02').toLocaleString('pt-BR', { month: 'long', year: 'numeric' })}</p>
                            </div>
                            
                            {/* Resumo */}
                            <div className="grid grid-cols-3 gap-4 mb-8">
                                <div className="p-4 bg-emerald-50 border border-emerald-100 rounded-xl text-center"><p className="text-xs text-emerald-600 font-bold uppercase">Entradas</p><p className="text-xl font-bold text-emerald-700">{new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(reportData.stats.income)}</p></div>
                                <div className="p-4 bg-rose-50 border border-rose-100 rounded-xl text-center"><p className="text-xs text-rose-600 font-bold uppercase">Saídas</p><p className="text-xl font-bold text-rose-700">{new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(reportData.stats.expense)}</p></div>
                                <div className="p-4 bg-slate-100 border border-slate-200 rounded-xl text-center"><p className="text-xs text-slate-500 font-bold uppercase">Saldo</p><p className={`text-xl font-bold ${reportData.stats.income - reportData.stats.expense >= 0 ? 'text-slate-800' : 'text-rose-600'}`}>{new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(reportData.stats.income - reportData.stats.expense)}</p></div>
                            </div>

                            {/* Gráficos */}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 page-break-inside-avoid">
                                <div className="bg-slate-50 p-4 rounded-xl border border-slate-100">
                                    <h4 className="text-sm font-bold text-emerald-700 mb-2 uppercase flex items-center gap-2"><Icons.TrendingUp size={16}/> Receitas por Categoria</h4>
                                    <canvas ref={incomeChartRef} id="incomeChart"></canvas>
                                    {Object.keys(reportData.stats.byCatIncome).length === 0 && <p className="text-xs text-slate-400 text-center py-4">Sem dados</p>}
                                </div>
                                <div className="bg-slate-50 p-4 rounded-xl border border-slate-100">
                                    <h4 className="text-sm font-bold text-rose-700 mb-2 uppercase flex items-center gap-2"><Icons.TrendingDown size={16}/> Despesas por Categoria</h4>
                                    <canvas ref={expenseChartRef} id="expenseChart"></canvas>
                                    {Object.keys(reportData.stats.byCatExpense).length === 0 && <p className="text-xs text-slate-400 text-center py-4">Sem dados</p>}
                                </div>
                            </div>

                            {/* Tabela */}
                            <div className="mt-8"><h3 className="text-sm font-bold text-slate-700 uppercase border-b-2 border-slate-200 pb-2 mb-4">Extrato Detalhado</h3>
                                <table className="w-full text-sm text-left border-collapse"><thead className="bg-slate-100 text-slate-600 font-bold uppercase text-xs"><tr><th className="p-2 rounded-l-lg">Data</th><th className="p-2">Descrição</th><th className="p-2 hidden sm:table-cell">Categoria</th><th className="p-2 text-right rounded-r-lg">Valor</th></tr></thead><tbody className="divide-y divide-gray-100">{reportData.filtered.map(t => (<tr key={t.id}><td className="p-2 text-slate-500 whitespace-nowrap">{new Date(t.date+'T00:00:00').toLocaleDateString('pt-BR')}</td><td className="p-2 font-medium text-slate-700">{t.description} {t.beneficiary !== 'eu' && <span className="text-[10px] bg-slate-100 px-1 rounded ml-1 text-slate-500 capitalize border border-slate-200">{t.beneficiary}</span>}</td><td className="p-2 text-slate-500 text-xs hidden sm:table-cell">{t.category || '-'}</td><td className={`p-2 text-right font-bold whitespace-nowrap ${t.type === 'income' ? 'text-emerald-600' : 'text-rose-600'}`}>{t.type === 'income' ? '+' : '-'}{new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(t.amount)}</td></tr>))}</tbody></table>
                                {reportData.filtered.length === 0 && <p className="text-center text-slate-400 py-8 italic border border-dashed border-slate-200 rounded-lg mt-2">Sem movimentações neste período.</p>}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const PremiumModal = ({ onActivate, deviceId, onClose }) => {
            const [key, setKey] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            const handleBuyClick = () => { window.open(`https://wa.me/${SEU_WHATSAPP_VENDAS}?text=${encodeURIComponent(`Olá! Quero comprar a licença do Nexus Finanças.\n\nMeu Código de Instalação é: *${deviceId}*`)}`, '_blank'); };
            const copyId = () => { try { navigator.clipboard.writeText(deviceId); alert("Código copiado!"); } catch (err) { alert("Erro ao copiar."); } };
            const handleActivate = () => { if(!key.trim()) { setError('Digite a chave recebida.'); return; } setLoading(true); setError(''); setTimeout(() => { if (verifyUniqueKey(key, deviceId)) { onActivate(key.trim()); } else { setError('Chave inválida para este aparelho.'); setLoading(false); } }, 800); };

            return (
                <div className="fixed inset-0 bg-slate-900/90 backdrop-blur-sm z-[200] flex items-center justify-center p-4">
                    <div className="bg-gradient-to-br from-slate-800 to-slate-900 w-full max-w-md rounded-3xl p-6 shadow-2xl animate-scaleIn text-white relative border border-slate-700/50">
                        <button onClick={onClose} className="absolute top-4 right-4 p-2 hover:bg-white/10 rounded-full transition-colors"><Icons.X size={20}/></button>
                        <div className="text-center mb-6"><div className="inline-block p-3 bg-emerald-500/20 rounded-2xl mb-4 text-emerald-400 shadow-lg shadow-emerald-900/20"><Icons.Crown size={48} /></div><h2 className="text-2xl font-bold mb-1">Versão Ilimitada</h2><p className="text-slate-400 text-sm">Você atingiu o limite de teste gratuito.</p></div>
                        <div className="mb-6 bg-slate-800/80 p-4 rounded-xl border border-slate-600/50">
                            <p className="text-[10px] text-slate-400 uppercase tracking-wider font-bold mb-2">Seu ID de Instalação</p>
                            <div className="flex items-center gap-2 mb-3"><code className="flex-1 bg-slate-900/80 p-2 rounded-lg font-mono text-center text-emerald-400 font-bold border border-slate-700">{deviceId}</code><button onClick={copyId} className="p-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-white transition-colors"><Icons.Copy size={18}/></button></div>
                             <button onClick={handleBuyClick} className="w-full py-3 bg-gradient-to-r from-emerald-600 to-teal-500 hover:from-emerald-500 hover:to-teal-400 rounded-xl font-bold text-white shadow-lg shadow-emerald-900/20 flex items-center justify-center gap-2 transition-transform active:scale-95"><Icons.MessageCircle size={20} /> Comprar Licença ({LICENSE_PRICE})</button>
                        </div>
                        <div className="border-t border-slate-700 pt-4"><p className="text-xs text-slate-400 mb-2 text-center">Já tem a chave?</p><div className="flex gap-2"><input type="text" placeholder="XXXX-XXXX-XXXX-XXXX" className="flex-1 bg-slate-900/50 border border-slate-600 rounded-lg px-3 text-sm text-white focus:outline-none focus:border-emerald-500 uppercase font-mono" value={key} onChange={(e) => setKey(e.target.value)} /><button onClick={handleActivate} disabled={loading} className="px-4 py-2 bg-slate-700 hover:bg-white hover:text-slate-900 rounded-lg font-bold text-white text-xs transition-colors disabled:opacity-50">{loading ? '...' : 'VALIDAR'}</button></div>{error && <p className="text-rose-400 text-xs mt-2 text-center">{error}</p>}</div>
                    </div>
                </div>
            );
        };

        function App() {
            const [isPremium, setIsPremium] = useState(false);
            const [isChecking, setIsChecking] = useState(true);
            const [deviceId, setDeviceId] = useState('');
            const [backupWarning, setBackupWarning] = useState(false);
            const [showModal, setShowModal] = useState(false);
            const [showSettings, setShowSettings] = useState(false);
            const [showReport, setShowReport] = useState(false);
            const [showPremiumModal, setShowPremiumModal] = useState(false);
            const [transactions, setTransactions] = useState([]);
            const fileInputRef = useRef(null);
            const [saveStatus, setSaveStatus] = useState('idle');
            const [pendingImportData, setPendingImportData] = useState(null);
            const [filterMode, setFilterMode] = useState('month');
            const [selectedMonth, setSelectedMonth] = useState(() => { const now = new Date(); return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`; });
            const [editingId, setEditingId] = useState(null);
            const [itemToDelete, setItemToDelete] = useState(null);
            // Atualizado o estado inicial do form para incluir category
            const [formData, setFormData] = useState({ description: '', amount: '', type: 'expense', date: new Date().toISOString().split('T')[0], method: 'pix', beneficiary: 'eu', category: '', additionalInfo: '' });

            useEffect(() => {
                if (navigator.storage && navigator.storage.persist) { navigator.storage.persist(); }
                const id = getDeviceId();
                setDeviceId(id);
                const savedKey = localStorage.getItem('nexus_license_key');
                if (savedKey && verifyUniqueKey(savedKey, id)) { setIsPremium(true); } else { localStorage.removeItem('nexus_license_key'); }
                setIsChecking(false);
                const lastBackup = localStorage.getItem('nexus_last_backup');
                if (!lastBackup) { setBackupWarning(true); } else { const days = (new Date() - new Date(lastBackup)) / (1000 * 60 * 60 * 24); if (days > 7) setBackupWarning(true); }
            }, []);

            useEffect(() => {
                const saved = localStorage.getItem('nexus_finances_transactions');
                if (saved) { try { setTransactions(JSON.parse(saved)); setSaveStatus('saved'); setTimeout(() => setSaveStatus('idle'), 2000); } catch (e) { console.error(e); } }
            }, []);

            useEffect(() => {
                setSaveStatus('saving');
                localStorage.setItem('nexus_finances_transactions', JSON.stringify(transactions));
                const timer = setTimeout(() => { setSaveStatus('saved'); setTimeout(() => setSaveStatus('idle'), 3000); }, 600);
                return () => clearTimeout(timer);
            }, [transactions]);

            const unlockApp = (key) => { localStorage.setItem('nexus_license_key', key); setIsPremium(true); setShowPremiumModal(false); alert("Licença Premium Ativada!"); };
            const logout = () => { if(confirm("Deseja desativar?")) { localStorage.removeItem('nexus_license_key'); setIsPremium(false); } };
            const handleExportData = () => {
                if (!isPremium) { setShowSettings(false); setShowPremiumModal(true); return; }
                const licenseKey = localStorage.getItem('nexus_license_key');
                const backupData = { version: 2, license: { key: licenseKey, deviceId: deviceId }, data: transactions };
                const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `nexus-backup-${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                localStorage.setItem('nexus_last_backup', new Date().toISOString());
                setBackupWarning(false);
            };
            const handleImportClick = () => { if (!isPremium) { setShowSettings(false); setShowPremiumModal(true); return; } fileInputRef.current.click(); }
            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try { const content = JSON.parse(event.target.result); if (Array.isArray(content)) { setPendingImportData({ data: content, license: null }); } else if (content.data && Array.isArray(content.data)) { setPendingImportData(content); } else { alert('Arquivo inválido.'); } } catch (error) { alert('Erro ao ler arquivo.'); }
                };
                reader.readAsText(file);
                e.target.value = null;
            };
            const confirmImport = () => {
                if (pendingImportData) {
                    setTransactions(pendingImportData.data);
                    if (pendingImportData.license && verifyUniqueKey(pendingImportData.license.key, deviceId)) { localStorage.setItem('nexus_license_key', pendingImportData.license.key); setIsPremium(true); }
                    setPendingImportData(null); setShowSettings(false); alert('Dados restaurados!');
                }
            };
            const handleSaveTransaction = (e) => {
                e.preventDefault();
                if (!formData.description || !formData.amount) return;
                if (!editingId && !isPremium && transactions.length >= FREE_LIMIT) { setShowModal(false); setShowPremiumModal(true); return; }
                if (editingId) { setTransactions(transactions.map(t => t.id === editingId ? { ...t, ...formData, amount: parseFloat(formData.amount) } : t)); } 
                else { setTransactions([{ id: Date.now().toString(), ...formData, amount: parseFloat(formData.amount), createdAt: new Date().toISOString() }, ...transactions]); }
                setFormData({ description: '', amount: '', type: 'expense', date: new Date().toISOString().split('T')[0], method: 'pix', beneficiary: 'eu', category: '', additionalInfo: '' });
                setEditingId(null); setShowModal(false);
            };
            const handleOpenModal = (t = null) => {
                if (!t && !isPremium && transactions.length >= FREE_LIMIT) { setShowPremiumModal(true); return; }
                if (t) { setFormData(t); setEditingId(t.id); } else { setFormData({ description: '', amount: '', type: 'expense', date: new Date().toISOString().split('T')[0], method: 'pix', beneficiary: 'eu', category: '', additionalInfo: '' }); setEditingId(null); }
                setShowModal(true);
            };
            const filteredTransactions = useMemo(() => {
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const filtered = transactions.filter(t => {
                    const tDate = new Date(t.date + 'T00:00:00');
                    if (filterMode === 'day') return tDate.getTime() === today.getTime();
                    if (filterMode === 'week') { const weekAgo = new Date(today); weekAgo.setDate(today.getDate() - 7); return tDate >= weekAgo && tDate <= today; }
                    if (filterMode === 'month') return `${tDate.getFullYear()}-${String(tDate.getMonth()+1).padStart(2,'0')}` === selectedMonth;
                    return true;
                }).sort((a,b) => new Date(b.date) - new Date(a.date));
                return { all: filtered, incomes: filtered.filter(t => t.type === 'income'), expenses: filtered.filter(t => t.type === 'expense') };
            }, [transactions, filterMode, selectedMonth]);
            const stats = useMemo(() => filteredTransactions.all.reduce((acc, curr) => { curr.type === 'income' ? acc.income += curr.amount : acc.expense += curr.amount; return acc; }, { income: 0, expense: 0 }), [filteredTransactions]);
            const balance = stats.income - stats.expense;
            const getBeneficiaryLabel = (key) => { const labels = { 'eu': 'Eu', 'esposa': 'Esposa', 'filhos': 'Filhos', 'pais': 'Pais', 'irmaos': 'Irmãos', 'empresa': 'Empresa', 'outro': 'Outro' }; return labels[key] || key || 'Eu'; };

            if (isChecking) return <div className="min-h-screen bg-slate-900 flex items-center justify-center text-white"><Icons.Wallet className="animate-bounce" size={40} /></div>;

            return (
                <div className="bg-slate-50 pb-20 md:pb-0 animate-fadeIn text-slate-800 min-h-full">
                    <header className="bg-slate-900 text-white p-6 pb-24 rounded-b-[2.5rem] md:rounded-t-3xl md:rounded-b-[2.5rem] shadow-xl relative overflow-hidden">
                        <div className="absolute top-0 right-0 p-4 opacity-10 pointer-events-none"><Icons.Wallet size={120} /></div>
                        
                        {/* Botão Novo Lançamento para Desktop (Topo) */}
                        <div className="absolute top-6 left-6 hidden md:block z-50">
                             <button onClick={() => handleOpenModal()} className="px-4 py-2 bg-emerald-500 hover:bg-emerald-600 text-white font-bold rounded-lg shadow-lg flex items-center gap-2 transition-transform active:scale-95"><Icons.Plus size={18} /> Novo Lançamento</button>
                        </div>

                        <div className="absolute top-4 right-4 z-50 flex gap-2">
                             {!isPremium && <button onClick={() => setShowPremiumModal(true)} className="px-3 py-1.5 rounded-full bg-amber-500 hover:bg-amber-600 text-white text-xs font-bold shadow-lg flex items-center gap-1 animate-pulse-soft"><Icons.Crown size={14}/> <span>{transactions.length}/{FREE_LIMIT}</span></button>}
                            <button onClick={() => setShowSettings(true)} className={`p-2.5 rounded-full hover:bg-slate-700 transition-colors shadow-lg border flex items-center justify-center ${backupWarning ? 'bg-rose-500 border-rose-400 text-white animate-pulse-red' : 'bg-slate-800 text-slate-300 border-slate-700'}`}>{backupWarning ? <Icons.AlertOctagon size={20} /> : <Icons.Settings size={20} />}</button>
                        </div>
                        <div className="relative z-10 pt-2 text-center">
                            <h1 className="text-2xl font-bold tracking-tight">Nexus</h1>
                            <p className="text-emerald-400 text-xs font-bold uppercase tracking-widest bg-slate-800/50 px-2 py-1 rounded-full mt-1">Controle de Finanças</p>
                            <p className="text-[10px] text-slate-400 mt-2 font-medium">Aplicativo desenvolvido por Lucas Sebastião Barbosa Silva</p>
                            <div className={`mt-2 flex items-center justify-center gap-1 text-[10px] font-medium transition-all duration-300 ${saveStatus === 'saved' ? 'opacity-100' : 'opacity-0'}`}><Icons.CheckCircle2 size={12} className="text-emerald-400" /><span className="text-emerald-100">Salvo no dispositivo</span></div>
                            <div className="mt-4"><span className="text-slate-400 text-sm font-medium uppercase tracking-wider">Saldo Atual</span><div className={`text-4xl font-bold mt-1 ${balance >= 0 ? 'text-white' : 'text-rose-400'}`}>{new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(balance)}</div></div>
                        </div>
                        <div className="absolute bottom-2 left-0 w-full text-center"><p className="text-[9px] text-slate-500/80 flex items-center justify-center gap-1"><Icons.ShieldCheck size={10} /> 100% Privado & Seguro (LGPD)</p></div>
                    </header>

                    <main className="px-4 -mt-16 relative z-20 max-w-6xl mx-auto space-y-4">
                        <div className="flex items-center gap-2 bg-white p-2 rounded-xl shadow-sm border border-gray-100 overflow-x-auto no-scrollbar md:max-w-md md:mx-auto">
                            <button onClick={() => setFilterMode('day')} className={`px-3 py-2 rounded-lg text-xs font-bold whitespace-nowrap transition-all ${filterMode === 'day' ? 'bg-slate-800 text-white' : 'text-slate-500'}`}>Hoje</button>
                            <button onClick={() => setFilterMode('week')} className={`px-3 py-2 rounded-lg text-xs font-bold whitespace-nowrap transition-all ${filterMode === 'week' ? 'bg-slate-800 text-white' : 'text-slate-500'}`}>Semana</button>
                            <div className={`flex items-center gap-2 px-3 py-2 rounded-lg border transition-all ${filterMode === 'month' ? 'border-slate-800' : 'border-transparent'}`}><span className="text-xs font-bold">Mês:</span><input type="month" value={selectedMonth} onChange={(e) => { setSelectedMonth(e.target.value); setFilterMode('month'); }} className="bg-transparent border-none text-sm font-bold w-full outline-none" /></div>
                            {filterMode === 'month' && <button onClick={() => isPremium ? setShowReport(true) : setShowPremiumModal(true)} className="p-2 bg-slate-800 text-white rounded-lg hover:bg-slate-700 shadow-md transition-colors relative"><Icons.FileText size={18} />{!isPremium && <div className="absolute -top-1 -right-1 bg-amber-500 rounded-full p-0.5"><Icons.Lock size={10} className="text-white"/></div>}</button>}
                        </div>

                        {backupWarning && <div className="p-3 bg-amber-50 border border-amber-200 rounded-xl flex items-start gap-3 animate-fadeIn shadow-sm max-w-lg mx-auto"><div className="text-amber-600 mt-1"><Icons.Database size={20}/></div><div><p className="text-xs font-bold text-amber-800">Backup de Segurança</p><p className="text-[10px] text-amber-700 leading-relaxed">Seus dados são armazenados localmente. Recomendamos baixar um backup regularmente.</p></div></div>}

                        <div className="grid grid-cols-2 gap-3 max-w-lg mx-auto">
                            <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-4 flex flex-col justify-between"><div className="flex items-center gap-2 mb-2"><div className="p-2 bg-emerald-100 rounded-full text-emerald-600"><Icons.TrendingUp size={16} /></div><span className="text-xs font-semibold text-slate-500">Entradas</span></div><span className="text-lg font-bold text-emerald-600">{new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(stats.income)}</span></div>
                            <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-4 flex flex-col justify-between"><div className="flex items-center gap-2 mb-2"><div className="p-2 bg-rose-100 rounded-full text-rose-600"><Icons.TrendingDown size={16} /></div><span className="text-xs font-semibold text-slate-500">Saídas</span></div><span className="text-lg font-bold text-rose-600">{new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(stats.expense)}</span></div>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div className="bg-white rounded-xl shadow-md border border-gray-100 overflow-hidden h-fit">
                                <div className="bg-emerald-50 px-4 py-3 border-b border-emerald-100 flex items-center justify-between"><h3 className="font-bold text-emerald-800 flex items-center gap-2 text-sm"><Icons.TrendingUp size={16}/> Entradas</h3><span className="text-xs font-bold text-emerald-600 bg-white px-2 py-0.5 rounded-full border border-emerald-200">{filteredTransactions.incomes.length}</span></div>
                                <div className="divide-y divide-gray-50 p-2 max-h-[400px] overflow-y-auto">{filteredTransactions.incomes.map(t => (<div key={t.id} className="py-2 px-2 hover:bg-emerald-50/50 rounded-lg transition-colors group"><div className="flex justify-between items-center mb-1"><div className="flex-1 min-w-0 pr-2"><p className="font-bold text-sm text-slate-700 truncate">{t.description}</p><p className="text-[10px] text-slate-400 truncate">{new Date(t.date+'T00:00:00').toLocaleDateString('pt-BR')} • {t.method}</p></div><div className="text-right shrink-0 whitespace-nowrap"><span className="font-bold text-emerald-600 text-sm block">{new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(t.amount)}</span></div></div><div className="flex justify-between items-center mt-1"><span className="text-[9px] bg-slate-100 px-1.5 py-0.5 rounded text-slate-500 uppercase">{getBeneficiaryLabel(t.beneficiary)}</span><div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity"><button onClick={() => handleOpenModal(t)} className="text-slate-400 hover:text-emerald-600"><Icons.Pencil size={12} /></button><button onClick={() => setItemToDelete(t.id)} className="text-slate-400 hover:text-rose-500"><Icons.Trash2 size={12} /></button></div></div></div>))} {filteredTransactions.incomes.length === 0 && <p className="text-center text-xs text-slate-400 py-4 italic">Nenhuma entrada.</p>}</div>
                            </div>
                            <div className="bg-white rounded-xl shadow-md border border-gray-100 overflow-hidden h-fit">
                                <div className="bg-rose-50 px-4 py-3 border-b border-rose-100 flex items-center justify-between"><h3 className="font-bold text-rose-800 flex items-center gap-2 text-sm"><Icons.TrendingDown size={16}/> Saídas</h3><span className="text-xs font-bold text-rose-600 bg-white px-2 py-0.5 rounded-full border border-rose-200">{filteredTransactions.expenses.length}</span></div>
                                <div className="divide-y divide-gray-50 p-2 max-h-[400px] overflow-y-auto">{filteredTransactions.expenses.map(t => (<div key={t.id} className="py-2 px-2 hover:bg-rose-50/50 rounded-lg transition-colors group"><div className="flex justify-between items-center mb-1"><div className="flex-1 min-w-0 pr-2"><p className="font-bold text-sm text-slate-700 truncate">{t.description}</p><p className="text-[10px] text-slate-400 truncate">{new Date(t.date+'T00:00:00').toLocaleDateString('pt-BR')} • {t.method}</p></div><div className="text-right shrink-0 whitespace-nowrap"><span className="font-bold text-rose-600 text-sm block">- {new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(t.amount)}</span></div></div><div className="flex justify-between items-center mt-1"><span className="text-[9px] bg-slate-100 px-1.5 py-0.5 rounded text-slate-500 uppercase">{getBeneficiaryLabel(t.beneficiary)}</span><div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity"><button onClick={() => handleOpenModal(t)} className="text-slate-400 hover:text-emerald-600"><Icons.Pencil size={12} /></button><button onClick={() => setItemToDelete(t.id)} className="text-slate-400 hover:text-rose-500"><Icons.Trash2 size={12} /></button></div></div></div>))} {filteredTransactions.expenses.length === 0 && <p className="text-center text-xs text-slate-400 py-4 italic">Nenhuma saída.</p>}</div>
                            </div>
                        </div>
                        
                        <div className="mt-8 p-6 text-xs text-slate-600 text-center border-t border-slate-200 bg-slate-100 rounded-xl mb-24 md:mb-8">
                            <p className="font-bold mb-2 uppercase tracking-wide">Aviso Legal de Direitos Autorais</p>
                            <p className="leading-relaxed">
                                © 2025 Maria Jaqueline da Silva Pereira - CNPJ: 62.323.279/0001-00. <br/>
                                Todos os direitos reservados. Este software é protegido pelas leis de propriedade intelectual e direitos autorais internacionais.
                            </p>
                        </div>
                        <div className="h-20 md:hidden"></div>
                    </main>

                    {/* Barra Inferior (Visível APENAS no Mobile) */}
                    <nav className="fixed bottom-0 w-full bg-white border-t border-gray-100 pb-2 z-30 shadow-[0_-5px_15px_rgba(0,0,0,0.02)] md:hidden">
                        <div className="flex justify-center items-end max-w-lg mx-auto px-8 h-16">
                            <div className="relative -top-5">
                                <button onClick={() => handleOpenModal()} className="bg-slate-800 text-white p-4 rounded-full shadow-lg hover:bg-slate-700 transition-transform active:scale-95 border-4 border-slate-50">
                                    <Icons.Plus size={32} />
                                </button>
                            </div>
                        </div>
                    </nav>

                    {showModal && (<div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-end sm:items-center justify-center animate-fadeIn"><div className="bg-white w-full max-w-lg rounded-t-3xl sm:rounded-2xl p-6 shadow-2xl animate-slideUp max-h-[90vh] overflow-y-auto"><div className="flex justify-between items-center mb-6"><h2 className="text-xl font-bold text-slate-800">{editingId ? 'Editar' : 'Novo Lançamento'}</h2><button onClick={() => setShowModal(false)} className="p-2 bg-gray-100 rounded-full"><Icons.X size={20} /></button></div><form onSubmit={handleSaveTransaction} className="space-y-4"><div className="flex bg-gray-100 p-1 rounded-xl"><button type="button" onClick={() => setFormData({...formData, type: 'expense'})} className={`flex-1 py-2 rounded-lg font-medium text-sm flex items-center justify-center gap-2 transition-all ${formData.type === 'expense' ? 'bg-white text-rose-600 shadow-sm' : 'text-gray-500'}`}><Icons.TrendingDown size={16} /> Saída</button><button type="button" onClick={() => setFormData({...formData, type: 'income'})} className={`flex-1 py-2 rounded-lg font-medium text-sm flex items-center justify-center gap-2 transition-all ${formData.type === 'income' ? 'bg-white text-emerald-600 shadow-sm' : 'text-gray-500'}`}><Icons.TrendingUp size={16} /> Entrada</button></div><div><label className="block text-xs font-bold text-slate-500 uppercase">Valor</label><input type="number" step="0.01" required className="w-full p-3 bg-slate-50 border rounded-xl text-lg font-bold" value={formData.amount} onChange={(e) => setFormData({...formData, amount: e.target.value})} /></div><div><label className="block text-xs font-bold text-slate-500 uppercase">Descrição</label><input type="text" required className="w-full p-3 bg-slate-50 border rounded-xl" value={formData.description} onChange={(e) => setFormData({...formData, description: e.target.value})} /></div><div className="grid grid-cols-2 gap-4"><div><label className="block text-xs font-bold text-slate-500 uppercase">Data</label><input type="date" required className="w-full p-3 bg-slate-50 border rounded-xl" value={formData.date} onChange={(e) => setFormData({...formData, date: e.target.value})} /></div><div><label className="block text-xs font-bold text-slate-500 uppercase">Referente</label><select className="w-full p-3 bg-slate-50 border rounded-xl" value={formData.beneficiary} onChange={(e) => setFormData({...formData, beneficiary: e.target.value})}><option value="eu">Eu</option><option value="esposa">Esposa</option><option value="filhos">Filhos</option><option value="pais">Pais</option><option value="irmaos">Irmãos</option><option value="empresa">Empresa</option><option value="outro">Outro</option></select></div></div><div><label className="block text-xs font-bold text-slate-500 uppercase">Método</label><select className="w-full p-3 bg-slate-50 border rounded-xl" value={formData.method} onChange={(e) => setFormData({...formData, method: e.target.value})}><option value="pix">Pix</option><option value="money">Dinheiro</option><option value="card_credit">Crédito</option><option value="card_debit">Débito</option><option value="cheque">Cheque</option></select></div><div><label className="block text-xs font-bold text-slate-500 uppercase">Categoria <span className="text-[10px] font-normal text-slate-400 lowercase">(opcional)</span></label><select className="w-full p-3 bg-slate-50 border rounded-xl" value={formData.category} onChange={(e) => setFormData({...formData, category: e.target.value})}><option value="">Selecione...</option>{CATEGORIES.map(cat => <option key={cat} value={cat}>{cat}</option>)}</select></div><div><label className="block text-xs font-bold text-slate-500 uppercase">Infos</label><textarea className="w-full p-3 bg-slate-50 border rounded-xl" value={formData.additionalInfo} onChange={(e) => setFormData({...formData, additionalInfo: e.target.value})} /></div><button type="submit" className={`w-full py-3 rounded-lg font-bold text-white shadow-md ${formData.type === 'income' ? 'bg-emerald-600' : 'bg-rose-500'}`}>Salvar</button></form></div></div>)}
                    {showReport && (<ReportModal transactions={transactions} month={selectedMonth} onClose={() => setShowReport(false)} />)}
                    {showSettings && (<div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[60] flex items-center justify-center p-4 animate-fadeIn text-slate-800"><div className="bg-white rounded-2xl p-6 shadow-2xl max-w-sm w-full animate-scaleIn overflow-y-auto max-h-[90vh]"><div className="flex justify-between items-center mb-4"><h3 className="text-lg font-bold text-slate-800">Configurações</h3><button onClick={() => setShowSettings(false)} className="p-2 bg-gray-100 rounded-full"><Icons.X size={20}/></button></div><div className="bg-emerald-50 p-4 rounded-xl border border-emerald-100 mb-4"><p className="text-xs font-bold text-emerald-800 uppercase mb-1">{isPremium ? 'Licença Ativa (Device Locked)' : 'Versão Gratuita'}</p><div className="flex items-center gap-2 text-sm text-emerald-700 font-mono"><Icons.Smartphone size={16}/> <span>{deviceId}</span></div></div>{backupWarning && <div className="mb-4 p-3 bg-amber-50 border border-amber-200 rounded-xl flex items-center gap-3 animate-fadeIn"><div className="text-amber-600"><Icons.AlertOctagon size={24}/></div><div><p className="text-xs font-bold text-amber-700">Backup Recomendado</p><p className="text-[10px] text-amber-600">Seus dados ficam salvos neste navegador. Faça um backup.</p></div></div>}<div className="space-y-2"><button onClick={handleExportData} className="w-full p-3 border rounded-xl flex items-center gap-3 hover:bg-slate-50"><Icons.Download className="text-emerald-600"/> <span>Baixar Backup Completo</span> {!isPremium && <Icons.Lock size={14} className="ml-auto text-slate-300"/>}</button><button onClick={handleImportClick} className="w-full p-3 border rounded-xl flex items-center gap-3 hover:bg-slate-50"><Icons.Upload className="text-blue-600"/> <span>Restaurar Backup</span> {!isPremium && <Icons.Lock size={14} className="ml-auto text-slate-300"/>}</button>{isPremium && <button onClick={logout} className="w-full p-3 border border-rose-200 bg-rose-50 rounded-xl flex items-center gap-3 hover:bg-rose-100 mt-4 text-rose-700 font-bold"><Icons.LogOut className="text-rose-600"/> <span>Desativar Licença</span></button>}<input type="file" ref={fileInputRef} onChange={handleFileUpload} accept=".json" className="hidden" /></div></div></div>)}
                    {showPremiumModal && (<PremiumModal onActivate={unlockApp} deviceId={deviceId} onClose={() => setShowPremiumModal(false)} />)}
                    {pendingImportData && (<div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[70] flex items-center justify-center p-4 text-slate-800"><div className="bg-white rounded-2xl p-6 text-center shadow-2xl"><h3 className="text-lg font-bold mb-2">Confirmar Importação?</h3><p className="text-sm text-slate-500 mb-4">Isso substituirá todos os dados.</p><div className="flex gap-2"><button onClick={() => setPendingImportData(null)} className="flex-1 py-2 bg-slate-100 rounded">Cancelar</button><button onClick={confirmImport} className="flex-1 py-2 bg-blue-600 text-white rounded">Confirmar</button></div></div></div>)}
                    {itemToDelete && (<div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[70] flex items-center justify-center p-4 text-slate-800"><div className="bg-white rounded-2xl p-6 text-center shadow-2xl"><h3 className="text-lg font-bold mb-2">Excluir?</h3><div className="flex gap-2"><button onClick={() => setItemToDelete(null)} className="flex-1 py-2 bg-slate-100 rounded">Cancelar</button><button onClick={() => { setTransactions(transactions.filter(t => t.id !== itemToDelete)); setItemToDelete(null); }} className="flex-1 py-2 bg-rose-500 text-white rounded">Excluir</button></div></div></div>)}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

        // --- REGISTRO DO SERVICE WORKER (CORRIGIDO) ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // Adicionada verificação para evitar erro em ambiente de preview/local
                if (window.location.protocol.startsWith('http')) {
                    navigator.serviceWorker.register('./sw.js')
                        .then(reg => console.log('[PWA] SW Registrado:', reg.scope))
                        .catch(err => console.error('[PWA] Falha no SW:', err));
                } else {
                    console.log('[PWA] Registro de SW pulado: Requer protocolo HTTP/HTTPS (atual: ' + window.location.protocol + ')');
                }
            });
        }
    </script>
</body>
</html>
